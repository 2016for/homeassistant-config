
##################################################
## Inputs

input_boolean:

  alarmclock_enabled:
    initial: on

  alarmclock_cancel:
    initial: off


input_number:

  alarmclock_hour:
    initial: 7
    min: 0
    max: 23
    step: 1

  alarmclock_minute:
    initial: 05
    min: 0
    max: 55
    step: 5


##################################################
## Sensors
sensor:

  - platform: template
    sensors:
      alarmclock_time_template:
        value_template: '{{ "%0.02d:%0.02d" | format(states("input_number.alarmclock_hour") | int, states("input_number.alarmclock_minute") | int) }}'


##################################################
## Automations
automation:

  # Main Function
  - alias: Alarm Clock
    initial_state: 'on'
    trigger:
      - platform: time
        minutes: '/1'
        seconds: 00

    condition:
      - condition: template
        value_template: '{{ now().time().strftime("%H:%M") == states.sensor.alarmclock_time_template.state }}'
      - condition: state
        entity_id: input_boolean.alarmclock_enabled
        state: 'on'
      - condition: state
        entity_id: light.bedroom_light_level
        state: 'off'
      - condition: time
        weekday:
          - mon
          - tue
          - wed
          - thu
          - fri
      - condition: state
        entity_id: input_boolean.vacation_mode
        state: 'off'

    action:
      - service: script.alarmclock_activate

  # Alarmclock Cancel
  - alias: Alarmclock Cancel

    trigger:
      platform: state
      entity_id: input_boolean.alarmclock_cancel
      to: 'on'

    condition:
      - condition: state
        entity_id: script.alarmclock_activate
        state: 'on'

    action:
      - service: homeassistant.turn_off
        entity_id: script.alarmclock_activate
      - service: light.turn_off
        entity_id: light.bedroom_light_level
      - service: light.turn_off
        entity_id: light.kitchen_light_level
      - service: light.turn_off
        entity_id: light.diningroom_light_level
      - service: homeassistant.turn_off
        entity_id: media_player.basement_group
      - service: input_boolean.turn_off
        data:
          entity_id: input_boolean.alarmclock_cancel

##################################################
## Scripts
script:

  cancel_alarm:
    sequence:
      - service: automation.trigger
        entity_id: automation.alarmclock_cancel

# Bedroom lights on over 30 minutes
  alarmclock_activate:
    sequence:
      - service: light.turn_on
        entity_id: light.bedroom_light_level
        data:
          brightness: 25
      - delay: "00:05:00"
      - service: light.turn_on
        entity_id: light.bedroom_light_level
        data:
          brightness: 50
      - delay: "00:05:00"
      - service: light.turn_on
        entity_id: light.bedroom_light_level
        data:
          brightness: 75
      - delay: "00:05:00"
      - service: light.turn_on
        entity_id: light.bedroom_light_level
        data:
          brightness: 100
      - delay: "00:05:00"
      - service: light.turn_on
        entity_id: light.bedroom_light_level
        data:
          brightness: 125
      - delay: "00:05:00"
      - service: light.turn_on
        entity_id: light.bedroom_light_level
        data:
          brightness: 150
      - service: light.turn_on
        entity_id: light.kitchen_light_level
        data:
          brightness: 150
      - service: light.turn_on
        entity_id: light.diningroom_light_level
        data:
          brightness: 100
      - service: homeassistant.turn_off
        entity_id: switch.bedroom_outlet_switch_3
      # Cast media to cast group
      - service: input_select.select_option
        data:
          entity_id: input_select.playlist_content
          option: "WRCJ"
      - service: input_select.select_option
        data:
          entity_id: input_select.playlist_source
          option: "Basement Group"
      - service: script.turn_on
        entity_id: script.playlist_action
      # Gradually increase radio volume
      - delay: "00:00:04"
      - service: media_player.volume_set
        data:
          entity_id: media_player.bedroom_speaker
          volume_level: 0.3
      - service: media_player.volume_set
        data:
          entity_id: media_player.nadc338
          volume_level: 0.3
      - delay: "00:01:00"
      - service: media_player.volume_set
        data:
          entity_id: media_player.bedroom_speaker
          volume_level: 0.4
      - service: media_player.volume_set
        data:
          entity_id: media_player.nadc338
          volume_level: 0.4
      - delay: "00:01:00"
      - service: media_player.volume_set
        data:
          entity_id: media_player.bedroom_speaker
          volume_level: 0.5
      - service: media_player.volume_set
        data:
          entity_id: media_player.nadc338
          volume_level: 0.5
      # Cancel after 2 hours and disable alarmclock
      - delay: "02:00:00"
      - condition: and
        conditions:
          - condition: template
            value_template: '{{states.light.bedroom_light_level.attributes.brightness < 153}}'
          - condition: template
            value_template: '{{states.light.bedroom_light_level.attributes.brightness > 147}}'
          - condition: template
            value_template: '{{states.light.kitchen_light_level.attributes.brightness < 153}}'
          - condition: template
            value_template: '{{states.light.kitchen_light_level.attributes.brightness > 147}}'
          - condition: template
            value_template: '{{states.light.diningroom_light_level.attributes.brightness < 103}}'
          - condition: template
            value_template: '{{states.light.diningroom_light_level.attributes.brightness > 97}}'
      - service: automation.trigger
        entity_id: automation.alarmclock_cancel
      - service: input_boolean.turn_off
        data:
          entity_id: input_boolean.alarmclock_enabled
